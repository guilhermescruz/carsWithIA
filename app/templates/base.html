{% load static %}
<link rel="stylesheet" href="{% static 'css/base.css' %}">
<!DOCTYPE html>
<html lang="pt_br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}{% endblock %}</title>
    
    <!-- CSS base do projeto -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}" />
    
    <!-- Bloco para CSS especÃ­ficos de cada pÃ¡gina -->
    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <div class="main-container">
      
      <!-- BotÃ£o Mobile Menu (apenas para usuÃ¡rios logados em mobile) -->
      {% if user.is_authenticated %}
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Abrir menu">
          â˜°
        </button>
      {% endif %}
      
      <!-- Menu Lateral -->
      {% if user.is_authenticated %}
        <aside class="sidebar" id="sidebar">
          <!-- Header do Sidebar -->
          <div class="sidebar-header">
            <h2>ðŸš— G1TECH</h2>
            <p>Multimarcas</p>
          </div>

          <!-- SaudaÃ§Ã£o do usuÃ¡rio -->
          <div class="user-greeting">
            <div class="user-name">{{ user.username }}</div>
            <div class="user-role">UsuÃ¡rio</div>
          </div>

          <!-- NavegaÃ§Ã£o -->
          <nav class="sidebar-nav">
            <div class="nav-section">
              <div class="nav-section-title">Menu Principal</div>
              <ul class="nav-list">
                <li class="nav-item">
                  <a href="{% url 'cars_list' %}" class="nav-link" onclick="closeMobileMenu()">
                    <span class="nav-icon">ðŸš—</span>
                    Ver Carros
                  </a>
                </li>
                <li class="nav-item">
                  <a href="{% url 'new_car' %}" class="nav-link" onclick="closeMobileMenu()">
                    <span class="nav-icon">âž•</span>
                    Cadastrar Carro
                  </a>
                </li>
              </ul>
            </div>
          </nav>

          <!-- BotÃ£o de Logout -->
          <div class="logout-section">
            <a href="{% url 'logout' %}" class="logout-btn" onclick="closeMobileMenu()">
              <span class="nav-icon">ðŸšª</span>
              Sair
            </a>
          </div>
        </aside>
      {% endif %}

      <!-- ConteÃºdo Principal -->
      <div class="content {% if user.is_authenticated %}with-sidebar{% else %}no-sidebar{% endif %}">
        <!-- Header superior para usuÃ¡rios nÃ£o logados -->
        <header class="top-header {% if user.is_authenticated %}hidden{% endif %}">
          <div>
            <strong>ðŸš— G1TECH Multimarcas</strong>
          </div>
          <nav class="top-nav">
            <a href="{% url 'cars_list' %}">Carros</a>
            <a href="{% url 'register' %}">Cadastre-se</a>
            <a href="{% url 'login' %}">Entrar</a>
          </nav>
        </header>

        <!-- ConteÃºdo das pÃ¡ginas -->
        <main>{% block content %} {% endblock %}</main>

        <!-- Footer -->
        <footer>
          <p>&copy; 2025 G1TECH Multimarcas</p>
        </footer>
      </div>

      <!-- Overlay para mobile -->
      <div class="sidebar-overlay" onclick="closeMobileMenu()"></div>
    </div>

    <!-- JavaScript aprimorado para mobile -->
    <script>
      // VariÃ¡veis globais
      let isMobile = false;
      let sidebar = null;
      let overlay = null;
      let mobileBtn = null;

      // InicializaÃ§Ã£o
      document.addEventListener('DOMContentLoaded', function() {
        sidebar = document.getElementById('sidebar');
        overlay = document.querySelector('.sidebar-overlay');
        mobileBtn = document.querySelector('.mobile-menu-btn');
        
        checkScreenSize();
        
        // Event listeners
        window.addEventListener('resize', debounce(checkScreenSize, 250));
        
        // Fechar menu ao pressionar ESC
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && isMobile && sidebar && sidebar.classList.contains('mobile-open')) {
            closeMobileMenu();
          }
        });
        
        // Prevenir scroll do body quando menu mobile estÃ¡ aberto
        if (sidebar) {
          sidebar.addEventListener('transitionstart', function() {
            if (isMobile && sidebar.classList.contains('mobile-open')) {
              document.body.style.overflow = 'hidden';
            }
          });
          
          sidebar.addEventListener('transitionend', function() {
            if (isMobile && !sidebar.classList.contains('mobile-open')) {
              document.body.style.overflow = '';
            }
          });
        }
      });

      // Verificar tamanho da tela e ajustar comportamento
      function checkScreenSize() {
        const wasMobile = isMobile;
        isMobile = window.innerWidth <= 768;
        
        if (mobileBtn) {
          mobileBtn.style.display = isMobile && sidebar ? 'block' : 'none';
        }
        
        // Se mudou de mobile para desktop, fechar menu mobile
        if (wasMobile && !isMobile && sidebar) {
          closeMobileMenu();
        }
        
        // Se mudou de desktop para mobile, remover hover states
        if (!wasMobile && isMobile && sidebar) {
          sidebar.style.left = '';
        }
      }

      // Toggle do menu mobile
      function toggleMobileMenu() {
        if (!sidebar || !isMobile) return;
        
        const isOpen = sidebar.classList.contains('mobile-open');
        
        if (isOpen) {
          closeMobileMenu();
        } else {
          openMobileMenu();
        }
      }
      
      // Abrir menu mobile
      function openMobileMenu() {
        if (!sidebar || !overlay || !isMobile) return;
        
        sidebar.classList.add('mobile-open');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Focus management para acessibilidade
        const firstLink = sidebar.querySelector('.nav-link');
        if (firstLink) {
          setTimeout(() => firstLink.focus(), 300);
        }
      }

      // Fechar menu mobile
      function closeMobileMenu() {
        if (!sidebar || !overlay) return;
        
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
        
        // Retornar focus para o botÃ£o do menu
        if (mobileBtn && isMobile) {
          mobileBtn.focus();
        }
      }

      // FunÃ§Ã£o debounce para otimizar resize
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Touch gestures para mobile (opcional - deslizar para fechar)
      if ('ontouchstart' in window) {
        let startX = 0;
        let startY = 0;
        let isSwipe = false;
        
        document.addEventListener('touchstart', function(e) {
          if (!isMobile || !sidebar || !sidebar.classList.contains('mobile-open')) return;
          
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
          isSwipe = false;
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
          if (!isMobile || !sidebar || !sidebar.classList.contains('mobile-open')) return;
          
          const currentX = e.touches[0].clientX;
          const currentY = e.touches[0].clientY;
          const diffX = startX - currentX;
          const diffY = Math.abs(startY - currentY);
          
          // Se o movimento for principalmente horizontal para a esquerda
          if (diffX > 50 && diffY < 100) {
            isSwipe = true;
          }
        }, { passive: true });
        
        document.addEventListener('touchend', function(e) {
          if (!isMobile || !sidebar || !sidebar.classList.contains('mobile-open') || !isSwipe) return;
          
          closeMobileMenu();
        }, { passive: true });
      }
    </script>
  </body>
</html>